<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CALCULUS PLATINUM - Local Edition</title>
    
    <!-- ====== META ====== -->
    <meta name="theme-color" content="#00f3ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Calculus Platinum">
    <meta name="description" content="Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©">
    
    <!-- ====== ICONS ====== -->
    <link rel="icon" href="./icon-v2.png" type="image/png">
    <link rel="apple-touch-icon" href="./icon-v2.png">
    <link rel="manifest" href="./manifest.json">
    
    <!-- ====== LOCAL ASSETS (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª) ====== -->
    <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="./assets/fonts/cairo.css">
    
    <style>
        /* ====== THEME VARIABLES ====== */
        :root {
            --bg-body: #09090b;
            --bg-panel: #18181b;
            --bg-input: #09090b;
            --border-color: #27272a;
            --text-main: #fafafa;
            --text-mute: #a1a1aa;
            --shadow: rgba(0,0,0,0.5);
            --primary: #00f3ff;
            --success: #00ff9d;
            --danger: #ff2a6d;
            --warning: #ffde00;
            --glass: rgba(255,255,255,0.03);
            --info: #006fee;
        }

        [data-theme="light"] {
            --bg-body: #f4f4f5;
            --bg-panel: #ffffff;
            --bg-input: #f4f4f5;
            --border-color: #e4e4e7;
            --text-main: #18181b;
            --text-mute: #71717a;
            --shadow: rgba(0,0,0,0.1);
            --primary: #006fee;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --glass: rgba(0,0,0,0.03);
            --info: #3b82f6;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            transition: background-color 0.3s, color 0.3s, border-color 0.3s; 
        }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 50px;
        }

        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }

        /* ====== HEADER ====== */
        .header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 30px; 
            padding: 20px; 
            background: var(--bg-panel);
            border-radius: 16px; 
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px var(--shadow); 
            position: relative; 
            overflow: hidden;
        }
        
        .header-content h1 { 
            font-size: 1.8rem; 
            font-weight: 800; 
            letter-spacing: -1px; 
        }
        .header-content span { 
            color: var(--primary); 
        }
        
        /* Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª */
        .install-btn {
            display: none;
            background: var(--success);
            color: #000;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        /* Ø²Ø± Ø§Ù„Ø«ÙŠÙ… */
        .theme-toggle {
            background: var(--bg-input); 
            border: 1px solid var(--border-color);
            color: var(--text-main); 
            width: 40px; 
            height: 40px; 
            border-radius: 50%;
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 1.2rem; 
            transition: 0.3s;
        }
        .theme-toggle:hover { 
            border-color: var(--primary); 
            color: var(--primary); 
            transform: rotate(15deg); 
        }

        /* ====== STATS ====== */
        .stats-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px; 
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-panel); 
            padding: 20px; 
            border-radius: 12px;
            border: 1px solid var(--border-color); 
            text-align: center;
            box-shadow: 0 2px 10px var(--shadow);
        }
        .stat-val { 
            font-size: 2rem; 
            font-weight: 700; 
            line-height: 1.2; 
        }
        .stat-label { 
            font-size: 0.85rem; 
            color: var(--text-mute); 
            font-weight: 500; 
        }
        .stat-subject {
            font-size: 0.8rem;
            color: var(--text-mute);
            margin-top: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ====== CONTROLS ====== */
        .controls { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            justify-content: center; 
            margin-bottom: 30px; 
        }
        
        .btn {
            padding: 12px 20px; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer;
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn:active { transform: scale(0.96); }
        
        .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 15px -5px var(--primary); }
        .btn-success { background: var(--success); color: #fff; box-shadow: 0 4px 15px -5px var(--success); }
        .btn-danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: #fff; }
        .btn-secondary { background: var(--bg-panel); border: 1px solid var(--border-color); color: var(--text-main); }
        .btn-secondary:hover { border-color: var(--text-mute); }

        /* ====== TABLE ====== */
        .table-wrapper {
            background: var(--bg-panel); 
            border-radius: 16px; 
            overflow: hidden;
            border: 1px solid var(--border-color); 
            box-shadow: 0 10px 40px -10px var(--shadow);
        }
        
        .data-table { width: 100%; border-collapse: collapse; }
        
        .data-table th {
            background: var(--glass); 
            padding: 15px; 
            text-align: right;
            color: var(--text-mute); 
            font-size: 0.8rem; 
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table td {
            padding: 12px 15px; 
            border-bottom: 1px solid var(--border-color); 
            vertical-align: middle;
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover { background: var(--glass); }

        /* Inputs & Static Text */
        .inp {
            background: var(--bg-input); 
            border: 1px solid var(--border-color); 
            color: var(--text-main);
            padding: 8px; 
            border-radius: 6px; 
            text-align: center; 
            width: 70px;
            font-size: 0.95rem; 
            font-weight: 500;
        }
        .inp:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(var(--primary), 0.1); }
        
        .inp-ghost { opacity: 0.3; pointer-events: none; border-style: dashed; }
        
        .inp-full {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            text-align: right;
        }

        /* Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) */
        .static-text {
            display: block;
            padding: 8px;
            font-weight: 600;
            color: var(--text-main);
        }
        .static-coef {
            display: inline-block;
            padding: 5px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-weight: bold;
            color: var(--primary);
        }

        /* Actions */
        .actions { display: flex; gap: 5px; }
        .icon-btn {
            width: 32px; 
            height: 32px; 
            border-radius: 6px; 
            border: none; 
            background: transparent;
            color: var(--text-mute); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: 0.2s;
        }
        .icon-btn:hover { background: var(--bg-input); color: var(--text-main); }
        .btn-del:hover { color: var(--danger); background: rgba(255, 42, 109, 0.1); }
        .btn-edit:hover { color: var(--primary); background: rgba(0, 243, 255, 0.1); } /* (Ø£Ø®Ø¶Ø± - Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) */

        /* Avg Badge */
        .avg-badge {
            padding: 4px 10px; 
            border-radius: 20px; 
            font-weight: 700; 
            font-size: 0.85rem;
            display: inline-block; 
            min-width: 50px; 
            text-align: center;
        }

        /* ====== CHARTS ====== */
        .charts-area {
            background: var(--bg-panel); 
            border-radius: 16px; 
            padding: 20px;
            border: 1px solid var(--border-color); 
            margin-top: 30px; 
            display: none;
        }
        .chart-row { display: flex; align-items: center; margin-bottom: 12px; gap: 15px; }
        .chart-label { width: 120px; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chart-track { flex: 1; height: 10px; background: var(--bg-input); border-radius: 5px; overflow: hidden; }
        .chart-bar { height: 100%; border-radius: 5px; transition: width 1s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .chart-val { width: 40px; text-align: left; font-size: 0.85rem; font-weight: bold; }

        /* ====== MOBILE ====== */
        @media (max-width: 768px) {
            .data-table thead { display: none; }
            .data-table, .data-table tbody, .data-table tr, .data-table td { display: block; width: 100%; }
            .data-table tr {
                margin-bottom: 15px; 
                border: 1px solid var(--border-color);
                border-radius: 12px; 
                background: var(--bg-panel); 
                padding: 10px;
                box-shadow: 0 2px 8px var(--shadow);
            }
            .data-table td {
                display: flex; 
                justify-content: space-between; 
                align-items: center;
                padding: 10px 5px; 
                border-bottom: 1px solid var(--border-color); 
                text-align: left;
            }
            .data-table td:last-child { border-bottom: none; padding-top: 15px; justify-content: center; }
            .data-table td::before {
                content: attr(data-label); 
                color: var(--text-mute); 
                font-size: 0.85rem; 
                font-weight: 600;
            }
            .inp { width: 80px; }
            .header { flex-direction: column; gap: 15px; }
            .controls { gap: 8px; }
            .btn { padding: 10px 15px; font-size: 0.8rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .stat-card { padding: 15px 10px; }
            .stat-val { font-size: 1.5rem; }
        }

        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            .controls { flex-direction: column; align-items: stretch; }
            .btn { justify-content: center; }
        }

        /* ====== MODAL ====== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .modal-box {
            background: var(--bg-panel); padding: 30px; border-radius: 20px; 
            width: 400px; max-width: 100%;
            border: 1px solid var(--border-color); box-shadow: 0 20px 50px var(--shadow);
            transform: translateY(20px); transition: 0.3s; opacity: 0;
        }
        .modal-overlay.active .modal-box { transform: translateY(0); opacity: 1; }
        
        .slider-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .slider-row label { flex: 1; font-size: 0.9rem; text-transform: uppercase; }
        input[type="range"] { flex: 2; accent-color: var(--primary); cursor: pointer; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }

        /* ====== TOAST & INDICATOR ====== */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(50px);
            background: var(--bg-panel); color: var(--text-main); padding: 12px 25px; 
            border-radius: 50px; font-weight: 600; box-shadow: 0 5px 20px rgba(0,0,0,0.3); 
            border: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; 
            opacity: 0; transition: 0.4s; z-index: 2000;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .save-indicator {
            position: fixed; top: 20px; right: 20px; background: var(--glass);
            color: var(--success); padding: 6px 12px; border-radius: 20px; 
            border: 1px solid var(--success); font-size: 0.75rem; 
            display: flex; align-items: center; gap: 6px; opacity: 0; transition: 0.3s;
        }
        .save-indicator.show { opacity: 1; }
        .spinner { 
            width: 10px; height: 10px; border: 2px solid currentColor; 
            border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* PWA Status */
        .pwa-status {
            position: fixed; bottom: 10px; right: 10px; background: var(--bg-panel);
            border: 1px solid var(--border-color); border-radius: 8px; padding: 5px 10px;
            font-size: 0.7rem; color: var(--text-mute); display: none;
        }

        /* Color Gradients */
        .grade-excellent { background: linear-gradient(135deg, #00ff9d, #00ff00) !important; }
        .grade-good { background: linear-gradient(135deg, #00ff00, #ffff00) !important; }
        .grade-average { background: linear-gradient(135deg, #ffff00, #ffa500) !important; }
        .grade-poor { background: linear-gradient(135deg, #ffa500, #ff0000) !important; }
        .grade-fail { background: linear-gradient(135deg, #ff0000, #990000) !important; }
        .grade-empty { background: var(--text-mute) !important; }
    </style>
</head>
<body>
    <!-- PWA Status Indicator -->
    <div class="pwa-status" id="pwaStatus"></div>

    <!-- Save Indicator -->
    <div class="save-indicator" id="saveInd">
        <div class="spinner"></div> Ù…Ø­ÙÙˆØ¸
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>ğŸ“Š CALCULUS <span>PLATINUM</span></h1>
                <!-- (Ø£Ø­Ù…Ø±) ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† Ù‡Ù†Ø§ -->
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button class="install-btn" id="installBtn" style="display: none;">
                    <i class="fas fa-download"></i> ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                </button>
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
            </div>
        </header>

        <!-- Stats -->
        <div class="stats-grid" id="statsGrid"></div>

        <!-- Controls -->
        <div class="controls">
            <!-- (Ø£Ø­Ù…Ø±) ØªÙ… Ø­Ø°Ù Ø²Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù -->
            
            <button class="btn btn-primary" onclick="openSubjectModal()">
                <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
            </button>
            <button class="btn btn-success" onclick="calculateFinalGPA()">
                <i class="fas fa-calculator"></i> Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
            </button>
            <button class="btn btn-secondary" onclick="exportData()">
                <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button class="btn btn-secondary" onclick="document.getElementById('impFile').click()">
                <i class="fas fa-upload"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <input type="file" id="impFile" hidden accept=".json" onchange="importData(this)">
            
            <button class="btn btn-secondary" onclick="resetGradesOnly()" title="ØªØµÙÙŠØ± Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙÙ‚Ø·">
                <i class="fas fa-eraser"></i> Ù…Ø³Ø­ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
            </button>
            <button class="btn btn-danger" onclick="confirmReset()" title="ØªØµÙÙŠØ± ÙƒØ§Ù…Ù„">
                <i class="fas fa-trash-alt"></i> ØªØµÙÙŠØ± Ø§Ù„ÙƒÙ„
            </button>
        </div>

        <!-- Table -->
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="5%">#</th>
                        <th width="20%">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <th width="8%">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</th>
                        <th width="12%">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th>
                        <th width="12%">TD</th>
                        <th width="12%">TP</th>
                        <th width="12%">Ø£Ø®Ø±Ù‰</th>
                        <th width="10%">Ø§Ù„Ù…Ø¹Ø¯Ù„</th>
                        <th width="9%">ØªØ­ÙƒÙ…</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <!-- Charts -->
        <div class="charts-area" id="chartsArea">
            <h3 style="margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                <i class="fas fa-chart-bar" style="color: var(--primary);"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡
            </h3>
            <div id="chartsContainer"></div>
        </div>

        <!-- Critical Subjects Warning -->
        <div id="criticalWarning" style="display: none; margin-top: 20px; padding: 15px; background: rgba(255, 42, 109, 0.1); border: 1px solid var(--danger); border-radius: 12px; color: var(--danger);">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="criticalCount">0</span> Ù…Ø§Ø¯Ø© ØªØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† (Ù…Ø¹Ø¯Ù„ Ø£Ù‚Ù„ Ù…Ù† 10)
        </div>
    </div>

    <!-- SUBJECT MODAL (ADD & EDIT) (Ø£Ø®Ø¶Ø± - Ù†Ø§ÙØ°Ø© Ù…ÙˆØ­Ø¯Ø©) -->
    <div class="modal-overlay" id="subjectModal">
        <div class="modal-box">
            <h3 style="margin-bottom: 20px;" id="modalTitle"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <input type="hidden" id="editSubjectId"> <!-- Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø§Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-mute);">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                <input type="text" id="subjectName" class="inp inp-full" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-mute);">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</label>
                <input type="number" id="subjectCoef" class="inp inp-full" value="2" min="1" max="10">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-mute);">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</label>
                <div id="subjectSliders"></div>
                <div style="margin-top: 10px; padding: 10px; background: var(--bg-input); border-radius: 8px; text-align: center;">
                    <span id="subjectTotalPercent" style="font-weight: bold;">100%</span>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-success" style="flex: 1; justify-content: center;" onclick="saveSubjectFromModal()">
                    <i class="fas fa-check"></i> Ø­ÙØ¸
                </button>
                <button class="btn btn-secondary" style="flex: 1; justify-content: center;" onclick="closeModal('subjectModal')">
                    <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast"></div>

    <!-- MAIN SCRIPT -->
    <script>
        // ====== STATE ======
        const defaultData = [
            { id: 1, name: 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª', coef: 3, weights: {exam:60, td:40, tp:0, other:0}, grades: {exam:0, td:0, tp:0, other:0}, avg: 0 },
            { id: 2, name: 'ÙÙŠØ²ÙŠØ§Ø¡', coef: 3, weights: {exam:60, td:20, tp:20, other:0}, grades: {exam:0, td:0, tp:0, other:0}, avg: 0 }
        ];

        let subjects = JSON.parse(localStorage.getItem('calc_plat_data')) || defaultData;
        let theme = localStorage.getItem('calc_plat_theme') || 'dark';
        let debounceTimer;

        // ====== INIT ======
        window.onload = () => {
            applyTheme();
            renderTable();
            updateStats();
            initPWA();
            initSubjectModalUI(); // ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            checkCriticalSubjects();
        };

        // ====== THEME SYSTEM ======
        function toggleTheme() {
            theme = theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('calc_plat_theme', theme);
            applyTheme();
        }

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', theme);
            const icon = document.getElementById('themeIcon');
            icon.className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // ====== PWA FUNCTIONS ======
        function initPWA() {
            updatePWAStatus();
            window.addEventListener('online', () => { showToast('ğŸŸ¢ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù…Ø¹Ø§Ø¯', 'success'); updatePWAStatus(); });
            window.addEventListener('offline', () => { showToast('ğŸ”´ Ø£Ù†Øª ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'warning'); updatePWAStatus(); });
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(r => updatePWAStatus('Service Worker: Ù†Ø´Ø·'))
                    .catch(e => updatePWAStatus('Service Worker: ÙØ´Ù„'));
            }
            
            let deferredPrompt;
            const installBtn = document.getElementById('installBtn');
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'flex';
                installBtn.addEventListener('click', () => {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((res) => {
                        if (res.outcome === 'accepted') installBtn.style.display = 'none';
                        deferredPrompt = null;
                    });
                });
            });
        }

        function updatePWAStatus(status = '') {
            const statusEl = document.getElementById('pwaStatus');
            if (!status) {
                status = navigator.onLine ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„';
                if ('serviceWorker' in navigator) status += ' | SW: Ù†Ø´Ø·';
                if (window.matchMedia('(display-mode: standalone)').matches) status += ' | Ù…Ø«Ø¨Øª';
            }
            statusEl.textContent = status;
            statusEl.style.display = 'block';
        }

        // ====== INIT MODAL UI ======
        function initSubjectModalUI() {
            const container = document.getElementById('subjectSliders');
            const weights = {exam:60, td:30, tp:10, other:0};
            container.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ
            
            ['exam', 'td', 'tp', 'other'].forEach(key => {
                container.innerHTML += `
                    <div class="slider-row">
                        <label style="text-transform:uppercase; width:50px;">${key}</label>
                        <input type="range" id="sl_rg_${key}" min="0" max="100" value="0" oninput="syncModalSl('${key}', this.value)">
                        <input type="number" id="sl_nb_${key}" class="inp" style="width:60px" min="0" max="100" value="0" oninput="syncModalSl('${key}', this.value)">
                    </div>
                `;
            });
        }

        function syncModalSl(key, val) {
            document.getElementById(`sl_rg_${key}`).value = val;
            document.getElementById(`sl_nb_${key}`).value = val;
            calcModalTotalWeight();
        }

        function calcModalTotalWeight() {
            let total = 0;
            ['exam','td','tp','other'].forEach(k => total += parseInt(document.getElementById(`sl_rg_${k}`).value)||0);
            const el = document.getElementById('subjectTotalPercent');
            el.textContent = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total}%`;
            el.style.color = total === 100 ? 'var(--success)' : 'var(--danger)';
        }

        // ====== LOGIC ======
        function parseGrade(val) {
            if(val === '') return 0;
            let str = val.toString().replace(',', '.');
            let num = parseFloat(str);
            if(isNaN(num)) return 0;
            return Math.min(20, Math.max(0, num));
        }

        function calculateAvg(sub) {
            const w = sub.weights;
            const g = sub.grades;
            const total = (g.exam * w.exam + g.td * w.td + g.tp * w.tp + g.other * w.other) / 100;
            return Math.min(20, Math.max(0, total));
        }

        function getGradeColor(avg) {
            if(avg >= 16) return 'grade-excellent';
            if(avg >= 14) return 'grade-good';
            if(avg >= 12) return 'grade-average';
            if(avg >= 10) return 'grade-poor';
            if(avg > 0) return 'grade-fail';
            return 'grade-empty';
        }

        function saveData() {
            document.getElementById('saveInd').classList.add('show');
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                localStorage.setItem('calc_plat_data', JSON.stringify(subjects));
                document.getElementById('saveInd').classList.remove('show');
                updateStats();
                checkCriticalSubjects();
            }, 600);
        }

        // ====== RENDERING (TABLE) ======
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (subjects.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:40px; color:var(--text-mute);">
                    <i class="fas fa-book-open" style="font-size:2rem; margin-bottom:10px; display:block;"></i>
                    Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©.
                </td></tr>`;
                return;
            }

            subjects.forEach((sub, index) => {
                const tr = document.createElement('tr');
                
                const getAttr = (k) => sub.weights[k] > 0 ? '' : 'inp-ghost';
                const getPh = (k) => sub.weights[k] > 0 ? `${sub.weights[k]}%` : '--';
                const getVal = (k) => sub.weights[k] > 0 ? (sub.grades[k] || '') : '';

                const colorClass = getGradeColor(sub.avg);
                const displayAvg = sub.avg > 0 ? sub.avg.toFixed(2) : '0.00';
                
                tr.innerHTML = `
                    <td data-label="#">${index + 1}</td>
                    <!-- (Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ) Ø§Ù„Ø§Ø³Ù… Ø«Ø§Ø¨Øª Ø§Ù„Ø¢Ù† -->
                    <td data-label="Ø§Ù„Ù…Ø§Ø¯Ø©">
                        <span class="static-text">${sub.name}</span>
                    </td>
                    <!-- (Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ) Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø«Ø§Ø¨Øª Ø§Ù„Ø¢Ù† -->
                    <td data-label="Ø§Ù„Ù…Ø¹Ø§Ù…Ù„">
                        <span class="static-coef">${sub.coef}</span>
                    </td>
                    
                    <td data-label="Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†">
                        <input type="text" inputmode="decimal" class="inp" 
                               placeholder="${getPh('exam')}" value="${getVal('exam')}" 
                               onchange="updGrade(${sub.id}, 'exam', this.value)">
                    </td>
                    <td data-label="TD">
                        <input type="text" inputmode="decimal" class="inp ${getAttr('td')}" 
                               placeholder="${getPh('td')}" value="${getVal('td')}" 
                               onchange="updGrade(${sub.id}, 'td', this.value)">
                    </td>
                    <td data-label="TP">
                        <input type="text" inputmode="decimal" class="inp ${getAttr('tp')}" 
                               placeholder="${getPh('tp')}" value="${getVal('tp')}" 
                               onchange="updGrade(${sub.id}, 'tp', this.value)">
                    </td>
                    <td data-label="Ø£Ø®Ø±Ù‰">
                        <input type="text" inputmode="decimal" class="inp ${getAttr('other')}" 
                               placeholder="${getPh('other')}" value="${getVal('other')}" 
                               onchange="updGrade(${sub.id}, 'other', this.value)">
                    </td>
                    
                    <td data-label="Ø§Ù„Ù…Ø¹Ø¯Ù„">
                        <span class="avg-badge ${colorClass}" style="color: #000;">
                            ${displayAvg}
                        </span>
                    </td>
                    
                    <td data-label="ØªØ­ÙƒÙ…">
                        <div class="actions">
                            <!-- (Ø£Ø®Ø¶Ø±) Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù‚Ù„Ù…) -->
                            <button class="icon-btn btn-edit" onclick="openSubjectModal(${sub.id})" 
                                    aria-label="ØªØ¹Ø¯ÙŠÙ„" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø©">
                                <i class="fas fa-pen"></i>
                            </button>
                            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ±ØªÙŠØ¨ -->
                            <button class="icon-btn" onclick="move(${index}, -1)" title="Ù„Ø£Ø¹Ù„Ù‰"><i class="fas fa-chevron-up"></i></button>
                            <button class="icon-btn" onclick="move(${index}, 1)" title="Ù„Ø£Ø³ÙÙ„"><i class="fas fa-chevron-down"></i></button>
                            <!-- Ø²Ø± Ø§Ù„Ø­Ø°Ù -->
                            <button class="icon-btn btn-del" onclick="delSub(${sub.id})" title="Ø­Ø°Ù"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStats() {
            const len = subjects.length;
            const passed = subjects.filter(s => s.avg >= 10).length;
            let highest = null, lowest = null;
            if (len > 0) {
                highest = subjects.reduce((a, b) => a.avg > b.avg ? a : b);
                lowest = subjects.reduce((a, b) => a.avg < b.avg ? a : b);
            }

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-val" style="color:var(--primary)">${len}</div>
                    <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" style="color:var(--success)">${passed}</div>
                    <div class="stat-label">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ø¬Ø­Ø©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" style="color:var(--success)">${highest ? highest.avg.toFixed(2) : '0.00'}</div>
                    <div class="stat-label">Ø£Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø©</div>
                    <div class="stat-subject">${highest ? highest.name : '--'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" style="color:var(--danger)">${lowest ? lowest.avg.toFixed(2) : '0.00'}</div>
                    <div class="stat-label">Ø£Ø¯Ù†Ù‰ Ø¹Ù„Ø§Ù…Ø©</div>
                    <div class="stat-subject">${lowest ? lowest.name : '--'}</div>
                </div>
            `;
            
            // Charts
            const chartCont = document.getElementById('chartsContainer');
            const chartsArea = document.getElementById('chartsArea');
            if (len === 0) {
                chartsArea.style.display = 'none';
            } else {
                chartsArea.style.display = 'block';
                chartCont.innerHTML = '';
                subjects.forEach(sub => {
                    const pct = (sub.avg / 20) * 100;
                    const color = sub.avg >= 10 ? 'var(--success)' : 'var(--danger)';
                    chartCont.innerHTML += `
                        <div class="chart-row">
                            <div class="chart-label" title="${sub.name}">${sub.name}</div>
                            <div class="chart-track" title="${pct.toFixed(1)}%">
                                <div class="chart-bar" style="width: ${pct}%; background: ${color}"></div>
                            </div>
                            <div class="chart-val">${sub.avg.toFixed(2)}</div>
                        </div>`;
                });
            }
        }

        function checkCriticalSubjects() {
            const critical = subjects.filter(s => s.avg < 10 && s.avg > 0);
            const warningEl = document.getElementById('criticalWarning');
            if (critical.length > 0) {
                warningEl.style.display = 'block';
                document.getElementById('criticalCount').textContent = critical.length;
                setTimeout(() => warningEl.style.display = 'none', 10000);
            } else {
                warningEl.style.display = 'none';
            }
        }

        function updGrade(id, type, val) {
            const sub = subjects.find(s=>s.id===id);
            if (sub && sub.weights[type] > 0) {
                sub.grades[type] = parseGrade(val);
                sub.avg = calculateAvg(sub);
                saveData();
                renderTable();
            }
        }

        // ====== MODAL LOGIC (ADD / EDIT) ======
        // (Ø£Ø®Ø¶Ø±) Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© (ÙØ§Ø±ØºØ© Ù„Ù„Ø¥Ø¶Ø§ÙØ©ØŒ Ø£Ùˆ Ù…Ù…Ù„ÙˆØ¡Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
        function openSubjectModal(editId = null) {
            const isEdit = editId !== null;
            document.getElementById('modalTitle').innerHTML = isEdit ? 
                '<i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø©' : 
                '<i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©';
            
            document.getElementById('editSubjectId').value = isEdit ? editId : '';

            if (isEdit) {
                // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const sub = subjects.find(s => s.id === editId);
                document.getElementById('subjectName').value = sub.name;
                document.getElementById('subjectCoef').value = sub.coef;
                ['exam', 'td', 'tp', 'other'].forEach(key => {
                    syncModalSl(key, sub.weights[key]);
                });
            } else {
                // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ØªØµÙÙŠØ±
                document.getElementById('subjectName').value = '';
                document.getElementById('subjectCoef').value = 2;
                // Ø§ÙØªØ±Ø§Ø¶ÙŠ
                syncModalSl('exam', 60); syncModalSl('td', 30); syncModalSl('tp', 10); syncModalSl('other', 0);
            }
            
            calcModalTotalWeight();
            openModal('subjectModal');
        }

        function saveSubjectFromModal() {
            let total = 0;
            const weights = {};
            const keys = ['exam','td','tp','other'];
            
            keys.forEach(k => {
                const val = parseInt(document.getElementById(`sl_rg_${k}`).value) || 0;
                weights[k] = val;
                total += val;
            });
            
            if(total !== 100) { showToast('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ 100%', 'error'); return; }

            const name = document.getElementById('subjectName').value.trim() || 'Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©';
            const coef = Math.max(1, Math.min(10, parseInt(document.getElementById('subjectCoef').value) || 2));
            const editId = document.getElementById('editSubjectId').value;

            if (editId) {
                // (Ø£Ø®Ø¶Ø±) Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                const sub = subjects.find(s => s.id == editId);
                if (sub) {
                    sub.name = name;
                    sub.coef = coef;
                    sub.weights = weights;
                    sub.avg = calculateAvg(sub); // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ ÙÙŠ Ø­Ø§Ù„ ØªØºÙŠØ±Øª Ø§Ù„Ø£ÙˆØ²Ø§Ù†
                    showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
            } else {
                // (Ø£Ø®Ø¶Ø±) Ø­ÙØ¸ Ø¬Ø¯ÙŠØ¯
                subjects.push({
                    id: Date.now(), name: name, coef: coef, weights: weights,
                    grades: {exam:0, td:0, tp:0, other:0}, avg: 0
                });
                showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© "${name}"`, 'success');
            }
            
            saveData(); 
            renderTable();
            closeModal('subjectModal');
        }

        // ====== MODAL UTILITIES ======
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // ====== ACTIONS ======
        function delSub(id) {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) {
                subjects = subjects.filter(s => s.id !== id);
                saveData(); renderTable(); showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©', 'success');
            }
        }

        function move(idx, dir) {
            if(idx + dir < 0 || idx + dir >= subjects.length) return;
            [subjects[idx], subjects[idx + dir]] = [subjects[idx + dir], subjects[idx]];
            saveData(); renderTable();
        }

        function resetGradesOnly() {
            if(!subjects.length) return;
            if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§ØªØŸ')) {
                subjects.forEach(s => { s.grades = {exam:0, td:0, tp:0, other:0}; s.avg = 0; });
                saveData(); renderTable(); showToast('ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¯Ø±Ø¬Ø§Øª', 'success');
            }
        }

        function confirmReset() {
            if(!subjects.length) return;
            if(confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!')) {
                subjects = []; saveData(); renderTable(); showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
            }
        }

        // ====== CALCULATE / EXPORT ======
        function calculateFinalGPA() {
            if(!subjects.length) { showToast('Ø£Ø¶Ù Ù…ÙˆØ§Ø¯ Ø£ÙˆÙ„Ø§Ù‹', 'warning'); return; }
            let pts = 0, coefs = 0;
            subjects.forEach(s => { pts += s.avg * s.coef; coefs += s.coef; });
            const gpa = coefs ? (pts / coefs).toFixed(2) : "0.00";
            
            const toast = document.getElementById('toast');
            toast.innerHTML = `
                <div style="text-align: right;">
                    <div style="font-size: 1.1rem; margin-bottom: 5px; color: ${gpa >= 10 ? 'var(--success)' : 'var(--danger)'}">
                        <strong>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${gpa}</strong>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-mute);">
                        ${subjects.length} Ù…Ø§Ø¯Ø© | ${subjects.filter(s => s.avg >= 10).length} Ù†Ø§Ø¬Ø­Ø©
                    </div>
                </div>`;
            if (navigator.onLine) {
                const msg = `ğŸ“ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ: ${gpa}\nØ¹Ø¨Ø± Calculus Platinum`;
                toast.innerHTML += `<a href="https://wa.me/?text=${encodeURIComponent(msg)}" target="_blank" style="color:inherit; margin-right:10px"><i class="fab fa-whatsapp" style="font-size:1.2rem; color:var(--success)"></i></a>`;
            }
            toast.className = 'toast show';
            toast.style.borderLeft = gpa >= 10 ? '4px solid var(--success)' : '4px solid var(--danger)';
            setTimeout(() => toast.className = 'toast', 5000);
        }

        function exportData() {
            if(!subjects.length) return;
            const data = { subjects: subjects, exportedAt: new Date().toISOString() };
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const a = document.createElement('a');
            a.href = str; a.download = `calculus_backup.json`;
            document.body.appendChild(a); a.click(); a.remove();
            showToast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'success');
        }

        function importData(input) {
            if(!input.files[0]) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    subjects = data.subjects || data;
                    subjects.forEach(sub => { if(!sub.avg) sub.avg = calculateAvg(sub); });
                    saveData(); renderTable(); showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'success');
                } catch(x) { showToast('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­', 'error'); }
            };
            r.readAsText(input.files[0]);
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.borderLeft = type === 'error' ? '4px solid var(--danger)' : 
                               type === 'warning' ? '4px solid var(--warning)' : 
                               '4px solid var(--success)';
            t.className = 'toast show';
            setTimeout(() => t.className = 'toast', 3000);
        }

        window.onclick = function(e) {
            if (e.target.classList.contains('modal-overlay')) closeModal(e.target.id);
        }
    </script>
</body>
</html>

